'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

(function () {

    var vkService = window.app.xhrService;

    /**
     * @param mountNode
     * @constructor
     */
    function Conversations(mountNode) {
        var _this = this;

        this.mountNode = mountNode;
        this.userID = 0;
        this.messages = [];
        this.activeRequest = null;
        this.messages = [];
        this.messagesContainer = document.getElementById('messages-container');
        this.dialogsContainer = document.getElementById('dialogs-container');
        this.chartForm = document.getElementById("chart-form");
        this.messageInput = document.getElementById("message-input");

        this.newMessage = function (messages) {

            var arr = [];

            messages.forEach(function (item) {
                var obj = {};
                obj.out = 0;
                obj.body = item[6];
                obj.user = item[3];
                obj.out = item[3] === parseInt(_this.userID, 10) ? 1 : 0;
                arr.push(new window.app.model.Dialog(obj));
            });
            _this.messages.push(arr);
            _this.messagesContainer.appendChild(_this.createListFragment(arr.reverse(), messageRender));
        };

        this.formSubmit = function (event) {
            event.preventDefault();
            var message = event.target.message.value;
            vkService.sendMessage(_this.userID, message).then(function () {
                _this.messageInput.value = '';
                setTimeout(function () {
                    _this.messagesContainer.scrollTop = _this.messagesContainer.scrollHeight;
                }, 300);
            });
        };

        this.dialogSelect = function (event) {
            var id = event.target.closest('.conversation__message').dataset.id;
            _this.userID = event.target.closest('.conversation__message').dataset.id;
            _this.showUserMessages(id);
        };

        this.chartForm.addEventListener('submit', this.formSubmit);
        this.dialogsContainer.addEventListener('click', this.dialogSelect);

        this.destroy = function () {
            this.dialogsContainer.innerHTML = '';
            this.messagesContainer.innerHTML = '';
            this.chartForm.removeEventListener('submit', this.dialogSelect);
            this.dialogsContainer.removeEventListener('click', this.dialogSelect);
            window.app.messagesObserver.unsubscribeAll();
        };

        this.showDialogs();
        vkService.longPoll();
        window.app.messagesObserver.subscribe(this.newMessage);
    }

    /**
     * Shows dialogs into container
     * @param data
     */
    Conversations.prototype.showDialogs = function () {
        var _this2 = this;

        vkService.getDialogs().then(function (res) {
            _this2.renderDialogs(res);
        }).catch(function (err) {
            alert(err);
        });
    };

    Conversations.prototype.renderDialogs = function renderDialogs(data) {
        document.getElementById('dialogs-container').appendChild(this.createListFragment(data, dialogRender));
    };

    /**
     * Create document fragment from list
     * @param data {Vk_API_data}
     * @returns {DocumentFragment}
     */
    Conversations.prototype.createListFragment = function (data, nodeCreateFn) {

        var fragment = document.createDocumentFragment();

        for (var i = 0; i < data.length; i++) {
            var item = data[i];
            // fragment.appendChild(nodeCreateFn(`${user.first_name} ${user.last_name}`, user.photo_50));
            fragment.appendChild(nodeCreateFn(item));
        }
        return fragment;
    };

    Conversations.prototype.showUserMessages = function (uid) {
        var _this3 = this;

        document.getElementById('chart-form').dataset.id = uid;

        vkService.getMessages(uid).then(function (messages) {
            _this3.messages = messages;
            _this3.renderMesasges(messages);
        });
    };

    Conversations.prototype.renderMesasges = function (messages) {
        var container = document.getElementById('messages-container');
        container.innerHTML = "";
        container.appendChild(this.createListFragment(messages.reverse(), messageRender));
        container.scrollTop = container.scrollHeight;
    };

    /**
     *
     * @param message {Dialog}
     * @returns {Element}
     */
    var messageRender = function messageRender(message) {
        var div = document.createElement('div');

        if ((typeof message === 'undefined' ? 'undefined' : _typeof(message)) !== 'object') {
            return div;
        }
        // skip link messages
        if (message.body.length === 0) {
            div.style.display = 'none';
            return div;
        }

        div.className += "chart-message";
        if (message.out === 1) {
            div.className += " mine";
        }

        div.innerHTML = '<div class="chart-message__avatar">\n                            <div class="chart-message__avatar-content active">\n                                <img src="images/photo.png">\n                                <div class="chart-message__controls">\n                                    <span class="chart-message__control chart-message__control_star"></span>\n                                    <span class="chart-message__control chart-message__control_share"></span>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="chart-message__time">\n                            <!--<span>15 sec.</span>-->\n                        </div>\n                        <div class="chart-message__content">\n                            <p class="chart-message__text">\n                               ' + message.body + '\n                            </p>\n\n                        </div>';

        return div;
    };

    /**
     * render dom element for message
     * @param dialog
     * @returns {Element}
     */
    var dialogRender = function dialogRender(dialog) {
        var div = document.createElement('div');

        if ((typeof dialog === 'undefined' ? 'undefined' : _typeof(dialog)) !== 'object') return div;

        div.dataset.id = dialog.user.id;
        div.className += "conversation__message new";
        div.innerHTML = '<img class="conversation__avatar" src="' + dialog.user.photo + '">\n                            <div class="conversation__message-info">\n                                <h4 class="conversation__name">' + dialog.user.firstName + ' ' + dialog.user.lastName + '</h4>\n                                <p class="conversation__message-text">' + dialog.body + '</p>\n                            </div>\n                            <div class="conversation__message-info">\n                                <h4 class="conversation__name conversation__name_right">\n                                    <span class="conversation__message-count">' + dialog.out + '</span>\n                                    <span class="conversation__message-time">1 min</span>\n                                </h4>\n                                <p class="conversation__message-text conversation__name_right"><i\n                                        class="conversation__attachment"></i></p>\n                            </div>';
        return div;
    };

    app.conversationComponent = Conversations;
})();